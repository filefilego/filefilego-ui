<template>
    <div id="downloads-container"
        style="margin: 0px 10px; border: 1px solid rgb(234, 234, 234); background-color: rgb(255, 255, 255);">
        <div style="padding-left: 15px; padding-top: 15px; padding-right: 15px;">

            <div class="uk-grid-match" uk-grid>
                <div class="uk-width-expand">
                    <h4 style="color: rgb(13, 13, 13);  font-weight: 700; margin-top:10px;">
                        Downloads
                    </h4>
                </div>
                <div class="k-width-expand uk-text-right">
                    <div>
                        <button @click="openFileSearchModal" class="uk-button ffg-button-search " style="color:#000; font-weight: 500; padding:0px 10px;">
                            Search
                            <span style="color:#000;" class="uk-icon" uk-icon="icon: search"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 20px; margin-top:15px;">
                <div style="border:1px solid #d7d7d7; border-radius: 2px;">
                    <div style="padding: 30px 10px; border-bottom:1px solid #d7d7d7;" v-for="(d, idx) in downloads"
                        :key="d.contracts">
                        <div class="uk-grid-match" style="margin:0px;" uk-grid>
                            <div style="padding-left:0px;" class="uk-width-expand">
                                <div style="display: flex; align-items: center; height: 33px;">
                                    <span v-if="!expandFiles(idx)" style="margin-right:4px; background-color: #d2d6df; border-radius: 5px; color:#183153; cursor:pointer; font-weight: bold;" @click="toggleExpand(idx)" uk-icon="icon: chevron-down; ratio:1.1"></span>
                                    <span v-else style="margin-right:4px; background-color: #d2d6df; border-radius: 5px; cursor:pointer; font-weight: bold; color:#183153;" @click="toggleExpand(idx)" uk-icon="icon: chevron-up; ratio:1.1"></span>
                                    <span class="normal-txt" style="font-weight:600;"> {{ getDownloadType(d).name }}</span>
                                </div>
                            </div>
                            <div class="uk-width-auto">
                                <div
                                    style="padding-top:3px; padding-bottom:3px; border:1px solid #b4b4b4; border-radius: 9px;">
                                    <span uk-tooltip="Open download location" @click="openDownloadFolder" style="color:#000; cursor: pointer; margin-left:8px;" uk-icon="folder"></span> 
                                    
                                    <span v-if="!d.decrypted && !d.cancelled && !d.paused" uk-tooltip="Pause download" @click="pause(idx)" style="cursor:pointer; margin-left:0px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" version="1.1" viewBox="0 0 500 550"> <defs> <symbol id="w" overflow="visible"> <path d="m18.766-1.125c-0.96875 0.5-1.9805 0.875-3.0312 1.125-1.043 0.25781-2.1367 0.39062-3.2812 0.39062-3.3984 0-6.0898-0.94531-8.0781-2.8438-1.9922-1.9062-2.9844-4.4844-2.9844-7.7344 0-3.2578 0.99219-5.8359 2.9844-7.7344 1.9883-1.9062 4.6797-2.8594 8.0781-2.8594 1.1445 0 2.2383 0.13281 3.2812 0.39062 1.0508 0.25 2.0625 0.625 3.0312 1.125v4.2188c-0.98047-0.65625-1.9453-1.1406-2.8906-1.4531-0.94922-0.3125-1.9492-0.46875-3-0.46875-1.875 0-3.3516 0.60547-4.4219 1.8125-1.0742 1.1992-1.6094 2.8555-1.6094 4.9688 0 2.1055 0.53516 3.7617 1.6094 4.9688 1.0703 1.1992 2.5469 1.7969 4.4219 1.7969 1.0508 0 2.0508-0.14844 3-0.45312 0.94531-0.3125 1.9102-0.80078 2.8906-1.4688z"/> </symbol> <symbol id="c" overflow="visible"> <path d="m13.734-11.141c-0.4375-0.19531-0.87109-0.34375-1.2969-0.4375-0.41797-0.10156-0.83984-0.15625-1.2656-0.15625-1.2617 0-2.2305 0.40625-2.9062 1.2188-0.67969 0.80469-1.0156 1.9531-1.0156 3.4531v7.0625h-4.8906v-15.312h4.8906v2.5156c0.625-1 1.3438-1.7266 2.1562-2.1875 0.82031-0.46875 1.8008-0.70312 2.9375-0.70312 0.16406 0 0.34375 0.011719 0.53125 0.03125 0.19531 0.011719 0.47656 0.039062 0.84375 0.078125z"/> </symbol> <symbol id="b" overflow="visible"> <path d="m17.641-7.7031v1.4062h-11.453c0.125 1.1484 0.53906 2.0078 1.25 2.5781 0.70703 0.57422 1.7031 0.85938 2.9844 0.85938 1.0312 0 2.082-0.14844 3.1562-0.45312 1.082-0.3125 2.1914-0.77344 3.3281-1.3906v3.7656c-1.1562 0.4375-2.3125 0.76562-3.4688 0.98438-1.1562 0.22656-2.3125 0.34375-3.4688 0.34375-2.7734 0-4.9297-0.70312-6.4688-2.1094-1.5312-1.4062-2.2969-3.3789-2.2969-5.9219 0-2.5 0.75391-4.4609 2.2656-5.8906 1.5078-1.4375 3.582-2.1562 6.2188-2.1562 2.4062 0 4.332 0.73047 5.7812 2.1875 1.4453 1.4492 2.1719 3.3828 2.1719 5.7969zm-5.0312-1.625c0-0.92578-0.27344-1.6719-0.8125-2.2344-0.54297-0.57031-1.25-0.85938-2.125-0.85938-0.94922 0-1.7188 0.26562-2.3125 0.79688s-0.96484 1.2969-1.1094 2.2969z"/> </symbol> <symbol id="a" overflow="visible"> <path d="m9.2188-6.8906c-1.0234 0-1.793 0.17188-2.3125 0.51562-0.51172 0.34375-0.76562 0.85547-0.76562 1.5312 0 0.625 0.20703 1.1172 0.625 1.4688 0.41406 0.34375 0.98828 0.51562 1.7188 0.51562 0.92578 0 1.7031-0.32812 2.3281-0.98438 0.63281-0.66406 0.95312-1.4922 0.95312-2.4844v-0.5625zm7.4688-1.8438v8.7344h-4.9219v-2.2656c-0.65625 0.92969-1.3984 1.6055-2.2188 2.0312-0.82422 0.41406-1.8242 0.625-3 0.625-1.5859 0-2.8711-0.45703-3.8594-1.375-0.99219-0.92578-1.4844-2.1289-1.4844-3.6094 0-1.7891 0.61328-3.1016 1.8438-3.9375 1.2383-0.84375 3.1797-1.2656 5.8281-1.2656h2.8906v-0.39062c0-0.76953-0.30859-1.332-0.92188-1.6875-0.61719-0.36328-1.5703-0.54688-2.8594-0.54688-1.0547 0-2.0312 0.10547-2.9375 0.3125-0.89844 0.21094-1.7305 0.52344-2.5 0.9375v-3.7344c1.0391-0.25 2.0859-0.44141 3.1406-0.57812 1.0625-0.13281 2.125-0.20312 3.1875-0.20312 2.7578 0 4.75 0.54688 5.9688 1.6406 1.2266 1.0859 1.8438 2.8555 1.8438 5.3125z"/> </symbol> <symbol id="d" overflow="visible"> <path d="m7.7031-19.656v4.3438h5.0469v3.5h-5.0469v6.5c0 0.71094 0.14062 1.1875 0.42188 1.4375s0.83594 0.375 1.6719 0.375h2.5156v3.5h-4.1875c-1.9375 0-3.3125-0.39844-4.125-1.2031-0.80469-0.8125-1.2031-2.1797-1.2031-4.1094v-6.5h-2.4219v-3.5h2.4219v-4.3438z"/> </symbol> <symbol id="k" overflow="visible"> <path d="m12.766-13.078v-8.2031h4.9219v21.281h-4.9219v-2.2188c-0.66797 0.90625-1.4062 1.5703-2.2188 1.9844s-1.7578 0.625-2.8281 0.625c-1.8867 0-3.4336-0.75-4.6406-2.25-1.2109-1.5-1.8125-3.4258-1.8125-5.7812 0-2.3633 0.60156-4.2969 1.8125-5.7969 1.207-1.5 2.7539-2.25 4.6406-2.25 1.0625 0 2 0.21484 2.8125 0.64062 0.82031 0.42969 1.5664 1.0859 2.2344 1.9688zm-3.2188 9.9219c1.0391 0 1.8359-0.37891 2.3906-1.1406 0.55078-0.76953 0.82812-1.8828 0.82812-3.3438 0-1.457-0.27734-2.5664-0.82812-3.3281-0.55469-0.76953-1.3516-1.1562-2.3906-1.1562-1.043 0-1.8398 0.38672-2.3906 1.1562-0.55469 0.76172-0.82812 1.8711-0.82812 3.3281 0 1.4609 0.27344 2.5742 0.82812 3.3438 0.55078 0.76172 1.3477 1.1406 2.3906 1.1406z"/> </symbol> <symbol id="j" overflow="visible"> <path d="m10.5-3.1562c1.0508 0 1.8516-0.37891 2.4062-1.1406 0.55078-0.76953 0.82812-1.8828 0.82812-3.3438 0-1.457-0.27734-2.5664-0.82812-3.3281-0.55469-0.76953-1.3555-1.1562-2.4062-1.1562-1.0547 0-1.8594 0.38672-2.4219 1.1562-0.55469 0.77344-0.82812 1.8828-0.82812 3.3281 0 1.4492 0.27344 2.5586 0.82812 3.3281 0.5625 0.77344 1.3672 1.1562 2.4219 1.1562zm-3.25-9.9219c0.67578-0.88281 1.4219-1.5391 2.2344-1.9688 0.82031-0.42578 1.7656-0.64062 2.8281-0.64062 1.8945 0 3.4453 0.75 4.6562 2.25 1.207 1.5 1.8125 3.4336 1.8125 5.7969 0 2.3555-0.60547 4.2812-1.8125 5.7812-1.2109 1.5-2.7617 2.25-4.6562 2.25-1.0625 0-2.0078-0.21094-2.8281-0.625-0.8125-0.42578-1.5586-1.0859-2.2344-1.9844v2.2188h-4.8906v-21.281h4.8906z"/> </symbol> <symbol id="i" overflow="visible"> <path d="m0.34375-15.312h4.8906l4.125 10.391 3.5-10.391h4.8906l-6.4375 16.766c-0.64844 1.6953-1.4023 2.8828-2.2656 3.5625-0.86719 0.6875-2 1.0312-3.4062 1.0312h-2.8438v-3.2188h1.5312c0.83203 0 1.4375-0.13672 1.8125-0.40625 0.38281-0.26172 0.67969-0.73047 0.89062-1.4062l0.14062-0.42188z"/> </symbol> <symbol id="f" overflow="visible"> <path d="m16.547-12.766c0.61328-0.94531 1.3477-1.6719 2.2031-2.1719 0.85156-0.5 1.7891-0.75 2.8125-0.75 1.7578 0 3.0977 0.54688 4.0156 1.6406 0.92578 1.0859 1.3906 2.6562 1.3906 4.7188v9.3281h-4.9219v-7.9844-0.35938c0.007813-0.13281 0.015625-0.32031 0.015625-0.5625 0-1.082-0.16406-1.8633-0.48438-2.3438-0.3125-0.48828-0.82422-0.73438-1.5312-0.73438-0.92969 0-1.6484 0.38672-2.1562 1.1562-0.51172 0.76172-0.77344 1.8672-0.78125 3.3125v7.5156h-4.9219v-7.9844c0-1.6953-0.14844-2.7852-0.4375-3.2656-0.29297-0.48828-0.8125-0.73438-1.5625-0.73438-0.9375 0-1.6641 0.38672-2.1719 1.1562-0.51172 0.76172-0.76562 1.8594-0.76562 3.2969v7.5312h-4.9219v-15.312h4.9219v2.2344c0.60156-0.86328 1.2891-1.5156 2.0625-1.9531 0.78125-0.4375 1.6406-0.65625 2.5781-0.65625 1.0625 0 2 0.25781 2.8125 0.76562 0.8125 0.51172 1.4258 1.2305 1.8438 2.1562z"/> </symbol> <symbol id="v" overflow="visible"> <path d="m2.3594-21.281h4.8906v21.281h-4.8906z"/> </symbol> <symbol id="u" overflow="visible"> <path d="m2.3594-21.281h4.8906v11.594l5.625-5.625h5.6875l-7.4688 7.0312 8.0625 8.2812h-5.9375l-5.9688-6.3906v6.3906h-4.8906z"/> </symbol> <symbol id="t" overflow="visible"> <path d="m2.3594-15.312h4.8906v15.312h-4.8906zm0-5.9688h4.8906v4h-4.8906z"/> </symbol> <symbol id="s" overflow="visible"> <path d="m14.312-14.828v3.7188c-1.043-0.4375-2.0547-0.76562-3.0312-0.98438-0.98047-0.21875-1.9023-0.32812-2.7656-0.32812-0.92969 0-1.6211 0.11719-2.0781 0.34375-0.44922 0.23047-0.67188 0.58984-0.67188 1.0781 0 0.38672 0.17188 0.68359 0.51562 0.89062 0.34375 0.21094 0.95703 0.36719 1.8438 0.46875l0.85938 0.125c2.5078 0.32422 4.1953 0.85156 5.0625 1.5781 0.86328 0.73047 1.2969 1.8711 1.2969 3.4219 0 1.6367-0.60547 2.8672-1.8125 3.6875-1.1992 0.8125-2.9922 1.2188-5.375 1.2188-1.0234 0-2.0742-0.078125-3.1562-0.23438-1.0742-0.15625-2.1797-0.39453-3.3125-0.71875v-3.7188c0.96875 0.48047 1.9609 0.83984 2.9844 1.0781 1.0312 0.23047 2.0781 0.34375 3.1406 0.34375 0.95703 0 1.6758-0.12891 2.1562-0.39062 0.47656-0.26953 0.71875-0.66406 0.71875-1.1875 0-0.4375-0.16797-0.75781-0.5-0.96875-0.33594-0.21875-0.99609-0.38281-1.9844-0.5l-0.85938-0.10938c-2.1797-0.26953-3.7031-0.77344-4.5781-1.5156-0.875-0.73828-1.3125-1.8594-1.3125-3.3594 0-1.625 0.55078-2.8281 1.6562-3.6094 1.1133-0.78906 2.8203-1.1875 5.125-1.1875 0.89453 0 1.8359 0.074219 2.8281 0.21875 1 0.13672 2.082 0.35156 3.25 0.64062z"/> </symbol> <symbol id="h" overflow="visible"> <path d="m17.75-9.3281v9.3281h-4.9219v-7.1094c0-1.3438-0.03125-2.2656-0.09375-2.7656s-0.16797-0.86719-0.3125-1.1094c-0.1875-0.3125-0.44922-0.55469-0.78125-0.73438-0.32422-0.17578-0.69531-0.26562-1.1094-0.26562-1.0234 0-1.8242 0.39844-2.4062 1.1875-0.58594 0.78125-0.875 1.8711-0.875 3.2656v7.5312h-4.8906v-21.281h4.8906v8.2031c0.73828-0.88281 1.5195-1.5391 2.3438-1.9688 0.83203-0.42578 1.75-0.64062 2.75-0.64062 1.7695 0 3.1133 0.54688 4.0312 1.6406 0.91406 1.0859 1.375 2.6562 1.375 4.7188z"/> </symbol> <symbol id="g" overflow="visible"> <path d="m17.75-9.3281v9.3281h-4.9219v-7.1406c0-1.3203-0.03125-2.2344-0.09375-2.7344s-0.16797-0.86719-0.3125-1.1094c-0.1875-0.3125-0.44922-0.55469-0.78125-0.73438-0.32422-0.17578-0.69531-0.26562-1.1094-0.26562-1.0234 0-1.8242 0.39844-2.4062 1.1875-0.58594 0.78125-0.875 1.8711-0.875 3.2656v7.5312h-4.8906v-15.312h4.8906v2.2344c0.73828-0.88281 1.5195-1.5391 2.3438-1.9688 0.83203-0.42578 1.75-0.64062 2.75-0.64062 1.7695 0 3.1133 0.54688 4.0312 1.6406 0.91406 1.0859 1.375 2.6562 1.375 4.7188z"/> </symbol> <symbol id="r" overflow="visible"> <path d="m7.25-2.2188v8.0469h-4.8906v-21.141h4.8906v2.2344c0.67578-0.88281 1.4219-1.5391 2.2344-1.9688 0.82031-0.42578 1.7656-0.64062 2.8281-0.64062 1.8945 0 3.4453 0.75 4.6562 2.25 1.207 1.5 1.8125 3.4336 1.8125 5.7969 0 2.3555-0.60547 4.2812-1.8125 5.7812-1.2109 1.5-2.7617 2.25-4.6562 2.25-1.0625 0-2.0078-0.21094-2.8281-0.625-0.8125-0.42578-1.5586-1.0859-2.2344-1.9844zm3.25-9.9062c-1.0547 0-1.8594 0.38672-2.4219 1.1562-0.55469 0.77344-0.82812 1.8828-0.82812 3.3281 0 1.4492 0.27344 2.5586 0.82812 3.3281 0.5625 0.77344 1.3672 1.1562 2.4219 1.1562 1.0508 0 1.8516-0.37891 2.4062-1.1406 0.55078-0.76953 0.82812-1.8828 0.82812-3.3438 0-1.457-0.27734-2.5664-0.82812-3.3281-0.55469-0.76953-1.3555-1.1562-2.4062-1.1562z"/> </symbol> <symbol id="q" overflow="visible"> <path d="m12.422-21.281v3.2188h-2.7031c-0.6875 0-1.1719 0.125-1.4531 0.375-0.27344 0.25-0.40625 0.6875-0.40625 1.3125v1.0625h4.1875v3.5h-4.1875v11.812h-4.8906v-11.812h-2.4375v-3.5h2.4375v-1.0625c0-1.6641 0.46094-2.8984 1.3906-3.7031 0.92578-0.80078 2.3672-1.2031 4.3281-1.2031z"/> </symbol> <symbol id="e" overflow="visible"> <path d="m9.6406-12.188c-1.0859 0-1.9141 0.39062-2.4844 1.1719-0.57422 0.78125-0.85938 1.9062-0.85938 3.375s0.28516 2.5938 0.85938 3.375c0.57031 0.77344 1.3984 1.1562 2.4844 1.1562 1.0625 0 1.875-0.38281 2.4375-1.1562 0.57031-0.78125 0.85938-1.9062 0.85938-3.375s-0.28906-2.5938-0.85938-3.375c-0.5625-0.78125-1.375-1.1719-2.4375-1.1719zm0-3.5c2.6328 0 4.6914 0.71484 6.1719 2.1406 1.4766 1.418 2.2188 3.3867 2.2188 5.9062 0 2.5117-0.74219 4.4805-2.2188 5.9062-1.4805 1.418-3.5391 2.125-6.1719 2.125-2.6484 0-4.7148-0.70703-6.2031-2.125-1.4922-1.4258-2.2344-3.3945-2.2344-5.9062 0-2.5195 0.74219-4.4883 2.2344-5.9062 1.4883-1.4258 3.5547-2.1406 6.2031-2.1406z"/> </symbol> <symbol id="p" overflow="visible"> <path d="m2.5781-20.406h5.875l7.4219 14v-14h4.9844v20.406h-5.875l-7.4219-14v14h-4.9844z"/> </symbol> <symbol id="o" overflow="visible"> <path d="m2.1875-5.9688v-9.3438h4.9219v1.5312c0 0.83594-0.007813 1.875-0.015625 3.125-0.011719 1.25-0.015625 2.0859-0.015625 2.5 0 1.2422 0.03125 2.1328 0.09375 2.6719 0.070313 0.54297 0.17969 0.93359 0.32812 1.1719 0.20703 0.32422 0.47266 0.57422 0.79688 0.75 0.32031 0.16797 0.69141 0.25 1.1094 0.25 1.0195 0 1.8203-0.39062 2.4062-1.1719 0.58203-0.78125 0.875-1.8672 0.875-3.2656v-7.5625h4.8906v15.312h-4.8906v-2.2188c-0.74219 0.89844-1.5234 1.5586-2.3438 1.9844-0.82422 0.41406-1.7344 0.625-2.7344 0.625-1.7617 0-3.1055-0.53906-4.0312-1.625-0.92969-1.082-1.3906-2.6602-1.3906-4.7344z"/> </symbol> <symbol id="n" overflow="visible"> <path d="m2.5781-20.406h8.7344c2.5938 0 4.582 0.57812 5.9688 1.7344 1.3945 1.1484 2.0938 2.7891 2.0938 4.9219 0 2.1367-0.69922 3.7812-2.0938 4.9375-1.3867 1.1562-3.375 1.7344-5.9688 1.7344h-3.4844v7.0781h-5.25zm5.25 3.8125v5.7031h2.9219c1.0195 0 1.8047-0.25 2.3594-0.75 0.5625-0.5 0.84375-1.2031 0.84375-2.1094 0-0.91406-0.28125-1.6172-0.84375-2.1094-0.55469-0.48828-1.3398-0.73438-2.3594-0.73438z"/> </symbol> <symbol id="m" overflow="visible"> <path d="m2.3594-15.312h4.8906v15.031c0 2.0508-0.49609 3.6172-1.4844 4.7031-0.98047 1.082-2.4062 1.625-4.2812 1.625h-2.4219v-3.2188h0.85938c0.92578 0 1.5625-0.21094 1.9062-0.625 0.35156-0.41797 0.53125-1.2461 0.53125-2.4844zm0-5.9688h4.8906v4h-4.8906z"/> </symbol> <symbol id="l" overflow="visible"> <path d="m14.719-14.828v3.9844c-0.65625-0.45703-1.3242-0.79688-2-1.0156-0.66797-0.21875-1.3594-0.32812-2.0781-0.32812-1.3672 0-2.4336 0.40234-3.2031 1.2031-0.76172 0.79297-1.1406 1.9062-1.1406 3.3438 0 1.4297 0.37891 2.543 1.1406 3.3438 0.76953 0.79297 1.8359 1.1875 3.2031 1.1875 0.75781 0 1.4844-0.10938 2.1719-0.32812 0.6875-0.22656 1.3203-0.56641 1.9062-1.0156v4c-0.76172 0.28125-1.5391 0.48828-2.3281 0.625-0.78125 0.14453-1.5742 0.21875-2.375 0.21875-2.7617 0-4.9219-0.70703-6.4844-2.125-1.5547-1.4141-2.3281-3.3828-2.3281-5.9062 0-2.5312 0.77344-4.5039 2.3281-5.9219 1.5625-1.4141 3.7227-2.125 6.4844-2.125 0.80078 0 1.5938 0.074219 2.375 0.21875 0.78125 0.13672 1.5547 0.35156 2.3281 0.64062z"/> </symbol> </defs> <g> <path d="m252.56 167.44h62.719v225.68h-62.719z"/> <path d="m384.72 167.44h62.719v225.68h-62.719z"/> </g> </svg>
                                    </span> 
                                    <span v-if="!d.cancelled && d.paused" @click="resume(d)" style="color:#000; cursor:pointer; margin-left:10px;" uk-tooltip="Resume download" uk-icon="icon:play; ratio:1.2"></span>
                                    
                                    <!-- <span v-if="d.cancelled" @click="restartDownload(d)" style="color:#000; cursor:pointer; margin-left:10px;" uk-tooltip="Restart download" uk-icon="icon:refresh; ratio:1"></span> -->

                                    <span v-if="!d.cancelled && !d.decrypted" uk-tooltip="Cancel download" @click="removeDownload(idx)" style="color:#000; cursor: pointer; margin-left:8px; margin-right:8px;" uk-icon="close"></span>
                                    <span v-if="d.cancelled || d.decrypted" uk-tooltip="Remove download" @click="removeDownload(idx)" style="color:#000; cursor: pointer; margin-left:8px; margin-right:8px;" uk-icon="icon:trash;"></span>

                                </div>
                            </div>
                            <div class="uk-width-1-1" style="padding:0px; margin:0px; margin-top:14px;">
                                <div v-if="!d.cancelled" style="height:8px; background-color:#e6e6e6;">
                                    <div :style="'width: ' + getTotalSizeOfDownload(d).percentage + '%;'" style="background-color:#5cb85c; height:8px;">
                                    </div>
                                </div>
                                <!-- canceled progress  -->
                                <div v-else style="height:8px; background-color:#e6e6e6;">
                                    <div style="width: 100%; background-color:#f0506e; height:8px;">
                                    </div>
                                </div>
                                <div v-if="!d.cancelled" class="normal-txt" style="padding-top:4px;">
                                   <span style="font-size: 0.9em; font-weight: bold; "> {{ $filters.formatsize(getTotalSizeOfDownload(d).progress) }} / {{ $filters.formatsize(getTotalSizeOfDownload(d).total) }} </span>
                                    <div v-if="d.started" style="float:right;">
                                        <span v-if="$filters.formatsize(getTotalSizeOfDownload(d).speed) != '-1 B'" uk-icon="download"></span> 
                                        <span v-if="$filters.formatsize(getTotalSizeOfDownload(d).speed) != '-1 B'" style="font-size: 0.9em; font-weight: bold;"> {{ $filters.formatsize(getTotalSizeOfDownload(d).speed) }}/s</span> 

                                        <span v-if="d.paused" style="font-size: 0.9em; font-weight: bold; margin-left:10px;"> <span uk-icon="icon:warning; ratio:0.8;"></span> Download paused </span>

                                        <span v-if="getTotalSizeOfDownload(d).progress < getTotalSizeOfDownload(d).total" style="font-size: 0.9em; font-weight: bold;"> Remaining: {{ getTotalSizeOfDownload(d).remaining  }}</span> 
                                        <span>
                                            <span v-if="!d.paused && getTotalSizeOfDownload(d).progress >= getTotalSizeOfDownload(d).total && !d.decrypted" style="margin-left:8px; font-weight: bold;" class="uk-margin-small-right" uk-spinner="ratio: 0.7"> decrypting data </span>
                                            <span v-if="d.decrypted" style="padding:1px; margin-left:5px; color: #5cb85c; border: 1px solid #5cb85c; border-radius: 50%;" uk-icon="icon:check;ratio:0.9"></span>
                                        </span>
                                    </div>
                                    <div v-else style="float:right;">
                                        <span uk-icon="icon:future; ratio:0.9;"></span> <span style="font-size: 0.9em; font-weight: bold;"> Download is queued</span> 
                                    </div>
                                </div>
                                <!-- download cancelled  -->
                                <div v-else class="normal-txt" style="padding-top:4px;">
                                   <span style="font-size: 0.9em; font-weight: bold;"> {{ $filters.formatsize(getTotalSizeOfDownload(d).progress) }} / {{ $filters.formatsize(getTotalSizeOfDownload(d).total) }} </span>
                                    <div style="float:right;">
                                        <span style="font-size: 0.9em; font-weight: bold;"> <span uk-icon="icon:warning; ratio:0.8;"></span> Download cancelled </span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="expandFiles(idx)" class="uk-width-1-1" style="padding:0px; margin:0px; margin-top:14px;">
                                <table class="uk-table-middle uk-table uk-table-striped">
                                    <tbody>
                                        <tr class="normal-txt" v-for="(r) in expandedFiles(idx)" :key="r.name">
                                            <td>
                                                <img style="width:16px; height:16px; font-size: 32px; vertical-align: middle; "
                                                    :src="nodeVector(r.name)" /> {{ r.name }}
                                            </td>
                                            <td style="text-align: right;">
                                                {{ $filters.formatsize(r.size) }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; padding: 30px 0px; margin-top:20px; " v-if="downloads.length == 0">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="90pt"
                            height="90pt" version="1.1" viewBox="0 0 700 700">
                            <defs>
                                <symbol id="f" overflow="visible">
                                    <path
                                        d="m18.766-1.125c-0.96875 0.5-1.9805 0.875-3.0312 1.125-1.043 0.25781-2.1367 0.39062-3.2812 0.39062-3.3984 0-6.0898-0.94531-8.0781-2.8438-1.9922-1.9062-2.9844-4.4844-2.9844-7.7344 0-3.2578 0.99219-5.8359 2.9844-7.7344 1.9883-1.9062 4.6797-2.8594 8.0781-2.8594 1.1445 0 2.2383 0.13281 3.2812 0.39062 1.0508 0.25 2.0625 0.625 3.0312 1.125v4.2188c-0.98047-0.65625-1.9453-1.1406-2.8906-1.4531-0.94922-0.3125-1.9492-0.46875-3-0.46875-1.875 0-3.3516 0.60547-4.4219 1.8125-1.0742 1.1992-1.6094 2.8555-1.6094 4.9688 0 2.1055 0.53516 3.7617 1.6094 4.9688 1.0703 1.1992 2.5469 1.7969 4.4219 1.7969 1.0508 0 2.0508-0.14844 3-0.45312 0.94531-0.3125 1.9102-0.80078 2.8906-1.4688z" />
                                </symbol>
                                <symbol id="b" overflow="visible">
                                    <path
                                        d="m13.734-11.141c-0.4375-0.19531-0.87109-0.34375-1.2969-0.4375-0.41797-0.10156-0.83984-0.15625-1.2656-0.15625-1.2617 0-2.2305 0.40625-2.9062 1.2188-0.67969 0.80469-1.0156 1.9531-1.0156 3.4531v7.0625h-4.8906v-15.312h4.8906v2.5156c0.625-1 1.3438-1.7266 2.1562-2.1875 0.82031-0.46875 1.8008-0.70312 2.9375-0.70312 0.16406 0 0.34375 0.011719 0.53125 0.03125 0.19531 0.011719 0.47656 0.039062 0.84375 0.078125z" />
                                </symbol>
                                <symbol id="a" overflow="visible">
                                    <path
                                        d="m17.641-7.7031v1.4062h-11.453c0.125 1.1484 0.53906 2.0078 1.25 2.5781 0.70703 0.57422 1.7031 0.85938 2.9844 0.85938 1.0312 0 2.082-0.14844 3.1562-0.45312 1.082-0.3125 2.1914-0.77344 3.3281-1.3906v3.7656c-1.1562 0.4375-2.3125 0.76562-3.4688 0.98438-1.1562 0.22656-2.3125 0.34375-3.4688 0.34375-2.7734 0-4.9297-0.70312-6.4688-2.1094-1.5312-1.4062-2.2969-3.3789-2.2969-5.9219 0-2.5 0.75391-4.4609 2.2656-5.8906 1.5078-1.4375 3.582-2.1562 6.2188-2.1562 2.4062 0 4.332 0.73047 5.7812 2.1875 1.4453 1.4492 2.1719 3.3828 2.1719 5.7969zm-5.0312-1.625c0-0.92578-0.27344-1.6719-0.8125-2.2344-0.54297-0.57031-1.25-0.85938-2.125-0.85938-0.94922 0-1.7188 0.26562-2.3125 0.79688s-0.96484 1.2969-1.1094 2.2969z" />
                                </symbol>
                                <symbol id="j" overflow="visible">
                                    <path
                                        d="m9.2188-6.8906c-1.0234 0-1.793 0.17188-2.3125 0.51562-0.51172 0.34375-0.76562 0.85547-0.76562 1.5312 0 0.625 0.20703 1.1172 0.625 1.4688 0.41406 0.34375 0.98828 0.51562 1.7188 0.51562 0.92578 0 1.7031-0.32812 2.3281-0.98438 0.63281-0.66406 0.95312-1.4922 0.95312-2.4844v-0.5625zm7.4688-1.8438v8.7344h-4.9219v-2.2656c-0.65625 0.92969-1.3984 1.6055-2.2188 2.0312-0.82422 0.41406-1.8242 0.625-3 0.625-1.5859 0-2.8711-0.45703-3.8594-1.375-0.99219-0.92578-1.4844-2.1289-1.4844-3.6094 0-1.7891 0.61328-3.1016 1.8438-3.9375 1.2383-0.84375 3.1797-1.2656 5.8281-1.2656h2.8906v-0.39062c0-0.76953-0.30859-1.332-0.92188-1.6875-0.61719-0.36328-1.5703-0.54688-2.8594-0.54688-1.0547 0-2.0312 0.10547-2.9375 0.3125-0.89844 0.21094-1.7305 0.52344-2.5 0.9375v-3.7344c1.0391-0.25 2.0859-0.44141 3.1406-0.57812 1.0625-0.13281 2.125-0.20312 3.1875-0.20312 2.7578 0 4.75 0.54688 5.9688 1.6406 1.2266 1.0859 1.8438 2.8555 1.8438 5.3125z" />
                                </symbol>
                                <symbol id="c" overflow="visible">
                                    <path
                                        d="m7.7031-19.656v4.3438h5.0469v3.5h-5.0469v6.5c0 0.71094 0.14062 1.1875 0.42188 1.4375s0.83594 0.375 1.6719 0.375h2.5156v3.5h-4.1875c-1.9375 0-3.3125-0.39844-4.125-1.2031-0.80469-0.8125-1.2031-2.1797-1.2031-4.1094v-6.5h-2.4219v-3.5h2.4219v-4.3438z" />
                                </symbol>
                                <symbol id="i" overflow="visible">
                                    <path
                                        d="m12.766-13.078v-8.2031h4.9219v21.281h-4.9219v-2.2188c-0.66797 0.90625-1.4062 1.5703-2.2188 1.9844s-1.7578 0.625-2.8281 0.625c-1.8867 0-3.4336-0.75-4.6406-2.25-1.2109-1.5-1.8125-3.4258-1.8125-5.7812 0-2.3633 0.60156-4.2969 1.8125-5.7969 1.207-1.5 2.7539-2.25 4.6406-2.25 1.0625 0 2 0.21484 2.8125 0.64062 0.82031 0.42969 1.5664 1.0859 2.2344 1.9688zm-3.2188 9.9219c1.0391 0 1.8359-0.37891 2.3906-1.1406 0.55078-0.76953 0.82812-1.8828 0.82812-3.3438 0-1.457-0.27734-2.5664-0.82812-3.3281-0.55469-0.76953-1.3516-1.1562-2.3906-1.1562-1.043 0-1.8398 0.38672-2.3906 1.1562-0.55469 0.76172-0.82812 1.8711-0.82812 3.3281 0 1.4609 0.27344 2.5742 0.82812 3.3438 0.55078 0.76172 1.3477 1.1406 2.3906 1.1406z" />
                                </symbol>
                                <symbol id="h" overflow="visible">
                                    <path
                                        d="m10.5-3.1562c1.0508 0 1.8516-0.37891 2.4062-1.1406 0.55078-0.76953 0.82812-1.8828 0.82812-3.3438 0-1.457-0.27734-2.5664-0.82812-3.3281-0.55469-0.76953-1.3555-1.1562-2.4062-1.1562-1.0547 0-1.8594 0.38672-2.4219 1.1562-0.55469 0.77344-0.82812 1.8828-0.82812 3.3281 0 1.4492 0.27344 2.5586 0.82812 3.3281 0.5625 0.77344 1.3672 1.1562 2.4219 1.1562zm-3.25-9.9219c0.67578-0.88281 1.4219-1.5391 2.2344-1.9688 0.82031-0.42578 1.7656-0.64062 2.8281-0.64062 1.8945 0 3.4453 0.75 4.6562 2.25 1.207 1.5 1.8125 3.4336 1.8125 5.7969 0 2.3555-0.60547 4.2812-1.8125 5.7812-1.2109 1.5-2.7617 2.25-4.6562 2.25-1.0625 0-2.0078-0.21094-2.8281-0.625-0.8125-0.42578-1.5586-1.0859-2.2344-1.9844v2.2188h-4.8906v-21.281h4.8906z" />
                                </symbol>
                                <symbol id="g" overflow="visible">
                                    <path
                                        d="m0.34375-15.312h4.8906l4.125 10.391 3.5-10.391h4.8906l-6.4375 16.766c-0.64844 1.6953-1.4023 2.8828-2.2656 3.5625-0.86719 0.6875-2 1.0312-3.4062 1.0312h-2.8438v-3.2188h1.5312c0.83203 0 1.4375-0.13672 1.8125-0.40625 0.38281-0.26172 0.67969-0.73047 0.89062-1.4062l0.14062-0.42188z" />
                                </symbol>
                                <symbol id="e" overflow="visible">
                                    <path
                                        d="m2.1875-5.9688v-9.3438h4.9219v1.5312c0 0.83594-0.007813 1.875-0.015625 3.125-0.011719 1.25-0.015625 2.0859-0.015625 2.5 0 1.2422 0.03125 2.1328 0.09375 2.6719 0.070313 0.54297 0.17969 0.93359 0.32812 1.1719 0.20703 0.32422 0.47266 0.57422 0.79688 0.75 0.32031 0.16797 0.69141 0.25 1.1094 0.25 1.0195 0 1.8203-0.39062 2.4062-1.1719 0.58203-0.78125 0.875-1.8672 0.875-3.2656v-7.5625h4.8906v15.312h-4.8906v-2.2188c-0.74219 0.89844-1.5234 1.5586-2.3438 1.9844-0.82422 0.41406-1.7344 0.625-2.7344 0.625-1.7617 0-3.1055-0.53906-4.0312-1.625-0.92969-1.082-1.3906-2.6602-1.3906-4.7344z" />
                                </symbol>
                                <symbol id="s" overflow="visible">
                                    <path
                                        d="m0.42188-15.312h4.8906l3.8281 10.578 3.7969-10.578h4.9062l-6.0312 15.312h-5.375z" />
                                </symbol>
                                <symbol id="r" overflow="visible">
                                    <path
                                        d="m12.422-21.281v3.2188h-2.7031c-0.6875 0-1.1719 0.125-1.4531 0.375-0.27344 0.25-0.40625 0.6875-0.40625 1.3125v1.0625h4.1875v3.5h-4.1875v11.812h-4.8906v-11.812h-2.4375v-3.5h2.4375v-1.0625c0-1.6641 0.46094-2.8984 1.3906-3.7031 0.92578-0.80078 2.3672-1.2031 4.3281-1.2031z" />
                                </symbol>
                                <symbol id="d" overflow="visible">
                                    <path
                                        d="m9.6406-12.188c-1.0859 0-1.9141 0.39062-2.4844 1.1719-0.57422 0.78125-0.85938 1.9062-0.85938 3.375s0.28516 2.5938 0.85938 3.375c0.57031 0.77344 1.3984 1.1562 2.4844 1.1562 1.0625 0 1.875-0.38281 2.4375-1.1562 0.57031-0.78125 0.85938-1.9062 0.85938-3.375s-0.28906-2.5938-0.85938-3.375c-0.5625-0.78125-1.375-1.1719-2.4375-1.1719zm0-3.5c2.6328 0 4.6914 0.71484 6.1719 2.1406 1.4766 1.418 2.2188 3.3867 2.2188 5.9062 0 2.5117-0.74219 4.4805-2.2188 5.9062-1.4805 1.418-3.5391 2.125-6.1719 2.125-2.6484 0-4.7148-0.70703-6.2031-2.125-1.4922-1.4258-2.2344-3.3945-2.2344-5.9062 0-2.5195 0.74219-4.4883 2.2344-5.9062 1.4883-1.4258 3.5547-2.1406 6.2031-2.1406z" />
                                </symbol>
                                <symbol id="q" overflow="visible">
                                    <path
                                        d="m16.547-12.766c0.61328-0.94531 1.3477-1.6719 2.2031-2.1719 0.85156-0.5 1.7891-0.75 2.8125-0.75 1.7578 0 3.0977 0.54688 4.0156 1.6406 0.92578 1.0859 1.3906 2.6562 1.3906 4.7188v9.3281h-4.9219v-7.9844-0.35938c0.007813-0.13281 0.015625-0.32031 0.015625-0.5625 0-1.082-0.16406-1.8633-0.48438-2.3438-0.3125-0.48828-0.82422-0.73438-1.5312-0.73438-0.92969 0-1.6484 0.38672-2.1562 1.1562-0.51172 0.76172-0.77344 1.8672-0.78125 3.3125v7.5156h-4.9219v-7.9844c0-1.6953-0.14844-2.7852-0.4375-3.2656-0.29297-0.48828-0.8125-0.73438-1.5625-0.73438-0.9375 0-1.6641 0.38672-2.1719 1.1562-0.51172 0.76172-0.76562 1.8594-0.76562 3.2969v7.5312h-4.9219v-15.312h4.9219v2.2344c0.60156-0.86328 1.2891-1.5156 2.0625-1.9531 0.78125-0.4375 1.6406-0.65625 2.5781-0.65625 1.0625 0 2 0.25781 2.8125 0.76562 0.8125 0.51172 1.4258 1.2305 1.8438 2.1562z" />
                                </symbol>
                                <symbol id="p" overflow="visible">
                                    <path
                                        d="m17.75-9.3281v9.3281h-4.9219v-7.1094c0-1.3438-0.03125-2.2656-0.09375-2.7656s-0.16797-0.86719-0.3125-1.1094c-0.1875-0.3125-0.44922-0.55469-0.78125-0.73438-0.32422-0.17578-0.69531-0.26562-1.1094-0.26562-1.0234 0-1.8242 0.39844-2.4062 1.1875-0.58594 0.78125-0.875 1.8711-0.875 3.2656v7.5312h-4.8906v-21.281h4.8906v8.2031c0.73828-0.88281 1.5195-1.5391 2.3438-1.9688 0.83203-0.42578 1.75-0.64062 2.75-0.64062 1.7695 0 3.1133 0.54688 4.0312 1.6406 0.91406 1.0859 1.375 2.6562 1.375 4.7188z" />
                                </symbol>
                                <symbol id="o" overflow="visible">
                                    <path
                                        d="m2.5781-20.406h5.875l7.4219 14v-14h4.9844v20.406h-5.875l-7.4219-14v14h-4.9844z" />
                                </symbol>
                                <symbol id="n" overflow="visible">
                                    <path
                                        d="m17.75-9.3281v9.3281h-4.9219v-7.1406c0-1.3203-0.03125-2.2344-0.09375-2.7344s-0.16797-0.86719-0.3125-1.1094c-0.1875-0.3125-0.44922-0.55469-0.78125-0.73438-0.32422-0.17578-0.69531-0.26562-1.1094-0.26562-1.0234 0-1.8242 0.39844-2.4062 1.1875-0.58594 0.78125-0.875 1.8711-0.875 3.2656v7.5312h-4.8906v-15.312h4.8906v2.2344c0.73828-0.88281 1.5195-1.5391 2.3438-1.9688 0.83203-0.42578 1.75-0.64062 2.75-0.64062 1.7695 0 3.1133 0.54688 4.0312 1.6406 0.91406 1.0859 1.375 2.6562 1.375 4.7188z" />
                                </symbol>
                                <symbol id="m" overflow="visible">
                                    <path
                                        d="m2.5781-20.406h8.7344c2.5938 0 4.582 0.57812 5.9688 1.7344 1.3945 1.1484 2.0938 2.7891 2.0938 4.9219 0 2.1367-0.69922 3.7812-2.0938 4.9375-1.3867 1.1562-3.375 1.7344-5.9688 1.7344h-3.4844v7.0781h-5.25zm5.25 3.8125v5.7031h2.9219c1.0195 0 1.8047-0.25 2.3594-0.75 0.5625-0.5 0.84375-1.2031 0.84375-2.1094 0-0.91406-0.28125-1.6172-0.84375-2.1094-0.55469-0.48828-1.3398-0.73438-2.3594-0.73438z" />
                                </symbol>
                                <symbol id="l" overflow="visible">
                                    <path
                                        d="m2.3594-15.312h4.8906v15.031c0 2.0508-0.49609 3.6172-1.4844 4.7031-0.98047 1.082-2.4062 1.625-4.2812 1.625h-2.4219v-3.2188h0.85938c0.92578 0 1.5625-0.21094 1.9062-0.625 0.35156-0.41797 0.53125-1.2461 0.53125-2.4844zm0-5.9688h4.8906v4h-4.8906z" />
                                </symbol>
                                <symbol id="k" overflow="visible">
                                    <path
                                        d="m14.719-14.828v3.9844c-0.65625-0.45703-1.3242-0.79688-2-1.0156-0.66797-0.21875-1.3594-0.32812-2.0781-0.32812-1.3672 0-2.4336 0.40234-3.2031 1.2031-0.76172 0.79297-1.1406 1.9062-1.1406 3.3438 0 1.4297 0.37891 2.543 1.1406 3.3438 0.76953 0.79297 1.8359 1.1875 3.2031 1.1875 0.75781 0 1.4844-0.10938 2.1719-0.32812 0.6875-0.22656 1.3203-0.56641 1.9062-1.0156v4c-0.76172 0.28125-1.5391 0.48828-2.3281 0.625-0.78125 0.14453-1.5742 0.21875-2.375 0.21875-2.7617 0-4.9219-0.70703-6.4844-2.125-1.5547-1.4141-2.3281-3.3828-2.3281-5.9062 0-2.5312 0.77344-4.5039 2.3281-5.9219 1.5625-1.4141 3.7227-2.125 6.4844-2.125 0.80078 0 1.5938 0.074219 2.375 0.21875 0.78125 0.13672 1.5547 0.35156 2.3281 0.64062z" />
                                </symbol>
                            </defs>
                            <g>
                                <path
                                    d="m601.44 425.6-36.961-7.2812v-1.1211-257.6c-0.55859-10.078-8.9609-17.922-18.48-17.922l-392 0.003907c-10.078 0-18.48 8.3984-18.48 18.48v257.04 1.1211l-36.961 7.2812c-0.55859 0-0.55859 0.55859-0.55859 0.55859 0 7.8398 6.1602 13.441 14 13.441h477.12c7.2773-0.5625 12.879-6.1602 12.32-14 0.55859 0 0 0 0 0zm-251.44-280c1.6797 0 2.8008 1.1211 2.8008 2.8008-0.5625 1.6758-1.6797 2.7969-2.8008 2.7969-1.6797 0-2.8008-1.1211-2.8008-2.8008 0-1.6797 1.1211-2.7969 2.8008-2.7969zm-201.6 8.3984h403.2v252h-403.2zm228.48 271.6c0 1.6797-1.1211 2.8008-2.8008 2.8008h-48.16c-1.6797 0-2.8008-1.1211-2.8008-2.8008h-224l36.398-6.7188c0.55859 0.55859 1.1211 1.1211 2.2383 1.1211h424.48c1.1211 0 1.6797-0.55859 2.2383-1.1211l35.84 6.7188z" />
                                <path
                                    d="m374.08 422.8h-48.16c-1.6797 0-2.2383 1.1211-2.2383 2.8008h53.199c0-2.2422-1.1172-2.8008-2.8008-2.8008z" />
                                <path d="m316.4 291.2 33.602 44.801 33.602-44.801h-22.402v-112h-21.84l-0.55859 112z" />
                                <path d="m249.2 358.4h201.6v22.398h-201.6z" />
                            </g>
                        </svg>
                        <div>
                            <span class="normal-txt">              
                                You don't have any downloads yet. You can browse channels or use the search functionality here
                                to locate and download a file from the network.
                            </span>
                        </div>
                        <div style="margin-top:35px;">
                            <button @click="openFileSearchModal" class="uk-button ffg-button" style="font-weight: bold; text-transform: none; width:240px; height: 40px;">
                                Search by File Hash
                                <span class="uk-icon" uk-icon="icon: search"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-searchfile" uk-modal="container: #downloads-container; esc-close:false; bg-close:false;">
            <div style="padding-top: 17px; width: 60%; padding-bottom: 20px;" class="uk-modal-dialog uk-modal-body">
                <button id="close-modal-create" class="uk-modal-close-default" type="button" uk-close></button>
                <h2 class="modal-header">Search Files</h2>
                <div style="padding-bottom:10px; text-align: center; border-bottom:1px solid rgb(230, 230, 230);">
                    <img style="height: 48px; background-color: white; width: 48px; border-radius: 50%;"
                        src="/assets/icon.png" />

                </div>
                <div style="padding: 10px; margin-top:10px;">
                    <div style=" width:100%;" class="uk-inline">
                        <span style="color: #000;" class="uk-form-icon" uk-icon="icon: server"></span>
                        <input v-model="file_hashes" style="width:100%; border-radius: 4px;" class="normal-txt uk-input"
                            type="text" placeholder="File hash (can be a list of comma separated values)"
                            aria-label="Input">
                    </div>
                    <div v-if="searchError != ''" style="margin-top:10px; text-align: center;">
                        <span class="uk-text-small uk-text-danger"> <span style="margin-right:5px;"
                                uk-icon="icon: warning;"></span> {{ searchError }} </span>
                    </div>
                </div>

                <div v-if="responses.length > 0" style="padding: 10px; margin-top:10px;">
                    <div class="normal-txt" style="text-align: center;">
                        Select the provider from which to download the files:
                    </div>
                    <table class="uk-table-middle uk-table uk-table-striped">
                        <thead>
                            <tr>
                                <th style="text-transform:none;">Fees</th>
                                <th style="text-transform:none;"># Files available</th>
                                <th style="text-transform:none;">Total size</th>
                                <th style="text-transform:none; text-align: right;"><span class="uk-icon" uk-icon="icon: download"></span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="r in responses" :key="r.public_key">
                                <td style="">
                                    <span :uk-tooltip="isLessThan512KB(r) ? 'Files under 512KB are free': 'Free'" v-if="isFreeDownload(r) || isLessThan512KB(r)"
                                        style="background-color: rgb(62, 21, 202); line-height: 25px;"
                                        class="uk-badge">Free</span>
                                    
                                    
                                    <span v-if="isFreeDownload(r) || isLessThan512KB(r)" style="font-size: 0.9em; margin-top:5px; margin-left: 5px;">
                                        0 FFG </span>
                                    <span v-else style="font-size: 0.9em; margin-top:5px; margin-left: 5px;">
                                        {{ totalSPFees(r) }} FFG </span>
                                </td>
                                <td>
                                    <span style="font-size: 0.9em;"> {{ r.file_hashes.length }} / {{
                                        totalFileHashesForSearch() }} </span>
                                    <span uk-tooltip="Show files" @click="showFiles(r)"
                                        style="cursor: pointer; margin-left:7px;" uk-icon="eye"></span>
                                </td>
                                <td><span style="font-size: 0.9em;">{{ $filters.formatsize(totalSizeFromQueryResponse(r)) }}
                                    </span> </td>
                                <td style="text-align: right;">
                                    <span uk-tooltip="Some files are not available on this provider"
                                        v-if="r.unavailable_file_hashes.length > 0" class="uk-text-small uk-text-danger">
                                        <span style="margin-right:5px;" uk-icon="icon: warning;"></span> </span>
                                    
                                        <div style="padding-right: 4px;" v-if="speedTestError(r.from_peer_addr) != ''" class="uk-inline">
                                            <span uk-icon="icon: warning" style="color:red; cursor: pointer;"> </span>
                                            <div style="color: #c50000; font-size: 0.9em;" uk-dropdown="delay-hide:1;">
                                                {{speedTestError(r.from_peer_addr)}}
                                            </div>
                                        </div>
                                        <span v-if="getSpeedTestLoading(r.from_peer_addr)" class="uk-margin-small-right" uk-spinner="ratio: 1"></span>

                                        <button v-else @click="download(r)" class="uk-button ffg-button"
                                            style=" text-transform: none; padding:0; width:140px; height: 40px;">
                                            Download
                                            <span class="uk-icon" uk-icon="icon: download"></span>
                                        </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="normal-txt" style="text-align: center; padding: 10px; margin-top:5px;"
                    v-if="responses.length == 0 && !searching && checkDataQueryResponseInterval != null">
                    <span uk-icon="warning"></span> <span> No files found on the network, please try again</span>
                </div>

                <div v-if="searching" style="text-align: center; padding: 10px; margin-top:5px;">
                    <div style="padding-bottom:5px;" class="normal-txt">
                        We are currently searching the network for your data
                    </div>
                    <span class="uk-margin-small-right" uk-spinner="ratio: 1.4"></span>
                </div>

                <div v-else style="padding: 10px; margin-top:5px; text-align: center;">
                    <div v-if="downloadError != ''">
                        <span class="uk-text-small uk-text-danger"> <span style="margin-right:5px;"
                                uk-icon="icon: warning;"></span> {{ downloadError }} </span>
                    </div>

                    <button @click="searchNetwork" class="uk-button ffg-button"
                        style="font-weight: bold; text-transform: none; width:180px; height: 40px;">
                        Search
                        <span class="uk-icon" uk-icon="icon: search"></span>
                    </button>
                </div>
            </div>
        </div>

        <div id="modal-confirmDownload" uk-modal="container: #downloads-container; esc-close:false; bg-close:false;stack:true;">
            <div style="padding-top: 17px; padding-bottom: 20px;" class="uk-modal-dialog uk-modal-body">
                <button id="close-modal-create" class="uk-modal-close-default" type="button" uk-close></button>
                <h2 class="modal-header">Confirm Download</h2>
                <div style="padding-bottom:17px; text-align: center; border-bottom:1px solid rgb(230, 230, 230);">
                    <img style="height: 48px; background-color: white; width: 48px; border-radius: 50%;"
                        src="/assets/icon.png" />

                </div>
                
                <div class="normal-txt" style="margin-top:15px;">
                    <span style="font-weight: bold;">Total fees required: </span>  <span> Approximately {{ calculateRequiredFees(queryResponsesToBeDownloaded.providers) }} FFG </span>
                </div>


                <div v-if="downloadConfirmError!=''" style="margin-top:15px; ">
                    <span class="uk-text-small uk-text-danger"> 
                        <span style="margin-right:5px;" uk-icon="icon: warning;"></span>
                        {{ downloadConfirmError }}
                    </span>
                </div>


                <div v-if="downloadConfirmLoading" style="margin-top:15px;  text-align: center;">
                    <span class="uk-margin-small-right" uk-spinner="ratio: 1.4"></span>
                </div>

                <div class="normal-txt" v-if="downloadConfirmLoading && downloadConfirmLoadingMessage != ''" style="margin-top:15px;  text-align: center;">
                   <span> {{ downloadConfirmLoadingMessage }}</span>
                </div>

                <div v-if="!downloadConfirmLoading" style="padding: 10px; margin-top:5px; text-align: center;">
                    <button @click="confirmDownload" class="uk-button ffg-button"
                        style="text-transform: none; width:250px; height: 40px;">
                        Confirm Download
                        <span class="uk-icon" uk-icon="icon: download"></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="uk-flex-top" id="modal-showfiles"
            uk-modal="container: #downloads-container; esc-close:false; bg-close:false; stack:true;">
            <div style="padding-top: 17px; width: 60%; padding-bottom: 20px;"
                class="uk-modal-dialog uk-modal-body uk-margin-auto-vertical">
                <button id="close-modal-create" class="uk-modal-close-default" type="button" uk-close></button>
                <h2 class="uk-modal-title" style="font-size: 1.2em; font-weight: bold;">Files</h2>
                <div style="padding-bottom:10px; text-align: center; border-bottom:1px solid rgb(230, 230, 230);">
                    <img style="height: 48px; background-color: white; width: 48px; border-radius: 50%;"
                        src="/assets/icon.png" />

                </div>
                <div v-if="responses.length > 0">
                    <table class="uk-table-middle uk-table uk-table-striped">
                        <thead>
                            <tr>
                                <th style="text-transform: none;">Name</th>
                                <th style="text-transform: none; text-align: right;">Total size</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(r, idx) in selected_response.file_names" :key="r.public_key">
                                <td class="normal-txt">
                                    <img style="width:16px; height:16px; font-size: 32px; vertical-align: middle; "
                                        :src="nodeVector(r)" /> {{ r }}
                                </td>
                                <td class="normal-txt" style="text-align: right;">
                                    {{ $filters.formatsize(selected_response.file_hashes_sizes[idx]) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>
</template>
        
<script>
const { ipcRenderer } = window.require("electron");
import axios from 'axios';
import { globalState, AddToDownloads, RemoveItemFromDownloads, PauseDownload, ResumeDownloads, RestartDownload} from '../../store';
import { ref } from 'vue';
import { Units } from "../../unit.js"
import BigNumber from 'bignumber.js';
import ftype from "../../filetype";
import { localNodeEndpoint } from "../../rpc"

export default {
    components: {
        // PaginationBar
    },
    data() {
        return {
            speedTestErrors: {},
            loadingSpeedTest: {},
            usedTransactionFeeForContractCreation: "0.001",
            downloadConfirmLoading: false,
            downloadConfirmLoadingMessage: "",
            downloadConfirmError: "",
            queryResponsesToBeDownloaded: { destinationFolder: false, providers: []},
            selectedDownloadExpandFiles: -1,
            selected_response: { file_names: [], file_hashes_sizes: [] },
            file_hashes: "",
            dataQueryRequestHash: "",
            checkDataQueryResponseInterval: null,
            responses: [],
            nodeAddress: "",
            searching: false,
            searchError: "",
            downloadError: ""
        }
    },
    computed: {
        downloads() {
            const downs = ref(globalState.downloads);
            return downs.value;
        },
        globalState() {
            return globalState
        },
        channelRegistrationFees() {
            let feedBig = new BigNumber(this.globalState.channel_creation_fees_ffg_hex, 16);
            let ffgFees = Units.convert(feedBig.toString(10), "FFGOne", "FFG")
            return ffgFees
        }
    },
    watch: {
        file_hashes() {
            if(!this.searching) {
                this.dataQueryRequestHash = ""
            }
        },
        downloads: {
            handler() {
                this.saveDownloads();
            },
            deep: true
        }
    },
    unmounted() {
        clearInterval(this.checkDataQueryResponseInterval);
    },
    async mounted() {
        const addr = ref(globalState.nodeAddress);
        if (addr.value != "") {
            this.nodeAddress = addr.value;
        }

        let hash = this.$route.query.hash;
        if(hash && hash != "") {
            this.file_hashes = hash;
            this.openFileSearchModal()
            this.searchNetwork()
        }

    },
    methods: {
        isFreeDownload(r) {
            let allFree = true
            r.file_fees_per_byte.forEach((o) => {
                if(o != "0x0") allFree = false;
            })
            return allFree;
        },
        isLessThan512KB(r){
            return r.file_hashes_sizes.filter((o) => o >= 512 * 1024).length == 0
        },
        restartDownload(d) {
            // not implemented
            d.fileDownloads = []
            RestartDownload(d)
        },
        resume(d) {
            d.fileDownloads = []
            ResumeDownloads(d)
        },
        pause(idx) {
            PauseDownload(idx)
        },
        removeDownload(idx) {
            RemoveItemFromDownloads(idx)
        },
        saveDownloads() {
            const s = ref(globalState.downloads);
            try {
                let all = JSON.parse(JSON.stringify(s.value))
                ipcRenderer.send("save-downloads", all);
            } catch (e) {
                return
            }
        },
        openDownloadFolder() {
            ipcRenderer.sendSync("open-folder", globalState.downloadsPath);
        },
        calculateRequiredFees(providers) {
            try {
                let total = new BigNumber(0, 10);
                providers.forEach((o, idx) => {
                    o.file_fees_per_byte.forEach((j, feesIdx) => {
                        let size = providers[idx].file_hashes_sizes[feesIdx]
                        let valBig = new BigNumber(j, 16);
                        let totalBytes = new BigNumber(size, 10);
                        let totalFees = totalBytes.mul(valBig);
                        total = total.plus(totalFees)
                    })
                })

                // add extra verification fee
                let verificationFFG = Units.convert("0.08", "FFG", "FFGOne")
                let verificationFFGOne = new BigNumber(verificationFFG, 10)
                total = total.plus(verificationFFGOne);

                return Units.convert(total.toString(10), "FFGOne", "FFG")
            } catch (e) {
                return "error"
            }
        },
        expandedFiles(idx) {
            let allFiles = this.downloads[idx].contracts.map((o) => {
                let files = o.file_hoster_response.file_names.map((j, index) => {
                    return {
                        name: j,
                        size: o.file_hoster_response.file_hashes_sizes[index]
                    }
                })

                return files;
            })

            return allFiles.flat()
        },
        toggleExpand(idx) {
            if(this.selectedDownloadExpandFiles == idx) {
                this.selectedDownloadExpandFiles = -1;
            } else {
                this.selectedDownloadExpandFiles = idx;
            }
        },
        expandFiles(idx) {
            return this.selectedDownloadExpandFiles == idx;
        },
        calculateThroughput(startTime, endTime, fileSize) {
            // Calculate the time difference in seconds
            const timeDiffSeconds = (endTime - startTime) / 1000;

            // Calculate the throughput in bytes per second
            const throughput = fileSize / timeDiffSeconds-1;

            return throughput;
        },
        calculateRemainingTime(startTime, totalSize, downloadedSize) {
            var currentTime = new Date().getTime();
            var elapsedTime = currentTime - startTime;
            
            if (elapsedTime <= 0 || downloadedSize <= 0) {
                return "Calculating..."; // Handle initial or zero progress
            }
            
            var remainingSize = totalSize - downloadedSize;
            var bytesPerMillisecond = downloadedSize / elapsedTime;
            var remainingTimeMilliseconds = remainingSize / bytesPerMillisecond;
            var remainingTimeSeconds = Math.ceil(remainingTimeMilliseconds / 1000);
            
            var hours = Math.floor(remainingTimeSeconds / 3600);
            var minutes = Math.floor((remainingTimeSeconds % 3600) / 60);
            var seconds = remainingTimeSeconds % 60;
            
            // Format the remaining time as HH:MM:SS
            var remainingTime = hours.toString().padStart(2, "0") + ":" +
                                minutes.toString().padStart(2, "0") + ":" +
                                seconds.toString().padStart(2, "0");
            
            return remainingTime;
        },
        calculateCompletionPercentage(totalFileSize, downloadedSize) {
            if (totalFileSize <= 0) {
                return 0;
            }

            var percentage = (downloadedSize / totalFileSize) * 100;
            return Math.round(percentage * 100) / 100;
        },
        getTotalSizeOfDownload(d) {
            let total = Number(0);
            d.contracts.filter((o) => {
                o.file_hashes_needed_sizes.filter((j) => {
                    total += j
                })
            })

            let download = Number(0);
            d.fileDownloads.filter((o) => {
                download += o.progress
            })

            let end_at = d.finished_at;
            if( end_at == null) {
                end_at = Date.now()
            }

            let start_at = d.started_at;
            if( start_at == null) {
                start_at = Date.now()
            }

            let speed = this.calculateThroughput(start_at, end_at, download)

            return { speed: speed, total: total, progress: download, percentage: this.calculateCompletionPercentage(total, download), remaining: this.calculateRemainingTime(d.started_at, total, download)}
        },
        getDownloadType(d) {
            // if(d.destinationFolder && d.destinationFolder != "") {
            //     return { type: "folder", name: d.destinationFolder }
            // }

            let totalFiles = 0
            d.contracts.filter((o) => {
                totalFiles+= o.file_hoster_response.file_names.length
            })

            if(totalFiles == 1) {
                return { type: "file", name: d.contracts[0].file_hoster_response.file_names[0] }
            } else {
                return { type: "files", name: totalFiles + " files" }
            }
        },
        async createContract(dataQueryHash, remotePeer) {
            try {
                const data = {
                    jsonrpc: '2.0',
                    method: "data_transfer.CreateContractsFromDataQueryResponses",
                    params: [{ allow_response_only_from_peer: remotePeer, data_query_request_hash: dataQueryHash }],
                    id: 1
                };
                const response = await axios.post(localNodeEndpoint, data);
                let contract_hashes = response.data.result.contract_hashes;

                let downloadContracts = [];
                for (let i = 0; i < contract_hashes.length; i++) {
                    const data2 = {
                        jsonrpc: '2.0',
                        method: "data_transfer.GetDownloadContract",
                        params: [{ contract_hash: contract_hashes[i] }],
                        id: 1
                    };
                    const response2 = await axios.post(localNodeEndpoint, data2);
                    let downloadContract = response2.data.result.contract;
                    downloadContracts.push(downloadContract)
                }

                return downloadContracts;
            } catch (e) {
                if (e.name == 'NetworkError') {
                    throw new Error(e.message);
                }

                throw new Error(e.response.data.error);
            }
        },
        speedTestError(storage_provider_peer_addr) {
            if(this.speedTestErrors[storage_provider_peer_addr] !== undefined) {
                if(this.speedTestErrors[storage_provider_peer_addr].includes("no addresses")) {
                    return "Storage provider seems to be offline";
                }

                if(this.speedTestErrors[storage_provider_peer_addr].includes("timeout") || this.speedTestErrors[storage_provider_peer_addr].includes("backoff")) {
                    return "Storage provider connection timeout";
                }

                return this.speedTestErrors[storage_provider_peer_addr]
            }
            return "";
        },
        getSpeedTestLoading(storage_provider_peer_addr) {
            if(this.loadingSpeedTest[storage_provider_peer_addr] !== undefined) {
                return this.loadingSpeedTest[storage_provider_peer_addr].loading;
            }
            return false;
        },
        async perfromSpeedTest(storage_provider_peer_addr) {
            try {
                delete this.speedTestErrors[storage_provider_peer_addr];
                this.loadingSpeedTest[storage_provider_peer_addr] = { loading: true }
                const data = {
                    jsonrpc: '2.0',
                    method: "storage.TestSpeedWithRemotePeer",
                    params: [{ peer_id: storage_provider_peer_addr, file_size: 1 }],
                    id: 1
                };

                let response = await axios.post(localNodeEndpoint, data);
                return response.data.result.download_throughput_mb;
            } catch (e) {
                this.speedTestErrors[storage_provider_peer_addr] = e.response.data.error
                return false;
            } finally {
                this.loadingSpeedTest[storage_provider_peer_addr] = { loading: false }
            }
        },
        async download(r, destinationFolder = false) {
            this.downloadError = "";
            // perform a speed test first
            let speedTestRes = await this.perfromSpeedTest(r.from_peer_addr)
            if(!speedTestRes) return;

            if (this.isFreeDownload(r) || this.isLessThan512KB(r)) {
                try {
                    let contracts = await this.createContract(this.dataQueryRequestHash, r.from_peer_addr)
                    if (contracts && contracts.length > 0) {
                        let downloadItem = {
                            cancelled: false,
                            paused: false,
                            decryptionError: "",
                            decrypted: false,
                            free_download: true,
                            destinationFolder: destinationFolder,
                            contracts: contracts,
                            started: false,
                            started_at: null,
                            finished_at: null,
                            queue: null,
                            fileDownloads: []
                        }
                        
                        let ok = AddToDownloads(downloadItem);
                        if(!ok) {
                            this.downloadError = "There is already an existing download with the same files"
                        } else {
                            this.closeFileSearchModal();
                        }
                    } else {
                        this.downloadError = "Error while trying to download, no contract found"
                    }
                } catch (e) {
                    this.downloadError = e.message;
                }

            } else {
                this.downloadConfirmError = "";
                this.queryResponsesToBeDownloaded = { destinationFolder: destinationFolder, providers: [r] }
                this.openDownloadConfirmationModal()
            }
        },
        async confirmDownload() {
            try {
                this.downloadConfirmLoadingMessage = "";
                this.downloadConfirmLoading = true;
                let resultInFFG = this.calculateRequiredFees(this.queryResponsesToBeDownloaded.providers);
                let balanceRes = await this.getBalance();
                let balanceBig = new BigNumber(balanceRes.balance_hex, 16);
                let feesRequired = Units.convert(resultInFFG, "FFG", "FFGOne")
                let feesRequiredFFGOne = new BigNumber(feesRequired, 10)
                if(balanceBig.lessThan(feesRequiredFFGOne)) {
                    this.downloadConfirmError = "You don't have enough coins to download data!";
                    this.downloadConfirmLoading = false;
                    return
                }

                // create the contract
                this.downloadConfirmLoadingMessage = "Creating a local contract"
                let contracts = await this.createContract(this.dataQueryRequestHash, this.queryResponsesToBeDownloaded.providers[0].from_peer_addr)
                if (contracts && contracts.length > 0) {
                    this.downloadConfirmLoadingMessage = "Sending contract to verifier and storage provider"
                    try {
                        let res = await this.sendContractToVerifierAndFileHoster(contracts[0].contract_hash)
                        if(!res) {
                            this.downloadConfirmError = "Failed to send contract to verifier and storage provider";
                            this.downloadConfirmLoading = false;
                            return 
                        }

                        this.downloadConfirmLoadingMessage = "Sending a transaction to the network"
                        
                        let feesFFGOneString = Units.convert(this.usedTransactionFeeForContractCreation, "FFG", "FFGOne")
                        let feesFFGOne = new BigNumber(feesFFGOneString, 10).toString(16)

                        // call data_transfer.CreateTransactionsWithDataPayloadFromContractHashes
                        const jwtAccessToken = ref(globalState.jwtAccessToken);
                        let txData = await this.createTransactionsWithDataPayloadFromContractHashes(jwtAccessToken.value, contracts[0].contract_hash, balanceRes.nounce, "0x"+feesFFGOne)
                        
                        
                    
                        let txSent = await this.sendRawTransaction(txData.transaction_data_bytes_hex[0]);

                        if(txSent.transaction.hash == "") {
                            this.downloadConfirmError = "Failed to broadcast transaction to network";
                            this.downloadConfirmLoading = false;
                        }

                        this.downloadConfirmLoadingMessage = "Waiting for transaction confirmation"
                        let tries = 0;
                        let transactionBroadcastedInterval = setInterval(async() => {
                            if(tries > 20) {
                                clearInterval(transactionBroadcastedInterval);
                                this.downloadConfirmError = "Timeout checking for transaction on verifier and storage provider.";
                                this.downloadConfirmLoading = false;
                                return
                            }
                            tries++
                            try {
                                let verified = await this.requestContractTransactionVerification(contracts[0].contract_hash)
                                if(verified) {
                                    clearInterval(transactionBroadcastedInterval);
                                    this.downloadConfirmError = "";

                                    let downloadItem = {
                                        cancelled: false,
                                        paused: false,
                                        decrypted: false,
                                        decryptionError: "",
                                        free_download: false,
                                        destinationFolder: this.queryResponsesToBeDownloaded.destinationFolder,
                                        contracts: contracts,
                                        started: false,
                                        started_at: null,
                                        finished_at: null,
                                        queue: null,
                                        fileDownloads: []
                                    }
                                
                                    let ok = AddToDownloads(downloadItem);
                                    if(!ok) {
                                        this.downloadConfirmError = "There is already an existing download with the same files"
                                    } else {
                                        this.downloadConfirmLoading = false;
                                        this.closeDownloadConfirmationModal()
                                        this.closeFileSearchModal()
                                    }

                                    this.downloadConfirmLoading = false;
                                }

                            } catch (e){
                                // this.downloadConfirmError = e.message;
                            }
                        }, 3000)
                        

                    } catch (e) {
                        this.downloadConfirmError = e.message;
                        this.downloadConfirmLoading = false;
                        return 
                    }
                    
                } else {
                    this.downloadConfirmError = "Failed to create your contract locally, please try again"
                    this.downloadConfirmLoading = false;
                }

            } catch (e) {
                this.downloadConfirmLoading = false;
                this.downloadConfirmError = e.message;
            }
            
        },
        async sendContractToVerifierAndFileHoster(contractHash) {
            try { 
                const data = {
                    jsonrpc: '2.0',
                    method: "data_transfer.SendContractToFileHosterAndVerifier",
                    params: [{ contract_hash: contractHash }],
                    id: 1
                };
                let response = await axios.post(localNodeEndpoint, data);
                return response.data.result.success;
            } catch (e) {
                if (e.name == 'NetworkError') {
                    throw new Error(e.message);
                }

                throw new Error(e.response.data.error);
            }
        },
        async createTransactionsWithDataPayloadFromContractHashes(accessToken, contractHash, currentNounce, txFeesToBeUsed) {
            try { 
                const data = {
                    jsonrpc: '2.0',
                    method: "data_transfer.CreateTransactionsWithDataPayloadFromContractHashes",
                    params: [{ access_token: accessToken, contract_hashes: [contractHash], current_nounce: currentNounce, transaction_fees_to_be_used: txFeesToBeUsed }],
                    id: 1
                };
                let response = await axios.post(localNodeEndpoint, data);
                return response.data.result;

            } catch (e) {
                if (e.name == 'NetworkError') {
                    throw new Error(e.message);
                }

                throw new Error(e.response.data.error);
            }
        },
        async sendRawTransaction(transactionJSON) {
            try { 
                const data = {
                    jsonrpc: '2.0',
                    method: "transaction.SendRawTransaction",
                    params: [{ raw_transaction: transactionJSON }],
                    id: 1
                };
                let response = await axios.post(localNodeEndpoint, data);
                return response.data.result;

            } catch (e) {
                if (e.name == 'NetworkError') {
                    throw new Error(e.message);
                }

                throw new Error(e.response.data.error);
            }
        },
        async requestContractTransactionVerification(contractHash) {
            try { 
                const data = {
                    jsonrpc: '2.0',
                    method: "data_transfer.RequestContractTransactionVerification",
                    params: [{ contract_hash: contractHash }],
                    id: 1
                };
                let response = await axios.post(localNodeEndpoint, data);
                return response.data.result.verified;

            } catch (e) {
                if (e.name == 'NetworkError') {
                    throw new Error(e.message);
                }

                throw new Error(e.response.data.error);
            }
        },
        totalSPFees(r) {
            try {
                let allFileFees = new BigNumber(0, 10);
                r.file_fees_per_byte.forEach((o, idx) => {
                    let size = r.file_hashes_sizes[idx]
                    let valBig = new BigNumber(o, 16);
                    let totalBytes = new BigNumber(size, 10);
                    let totalFees = totalBytes.mul(valBig);
                    allFileFees = allFileFees.plus(totalFees)
                })
                return Units.convert(allFileFees.toString(10), "FFGOne", "FFG")
            } catch (e) {
                return e.message
            }
        },
        totalFileHashesForSearch() {
            let parts = this.file_hashes.split(",").map((o) => o.trim()).filter((o) => o != "")
            return parts.length;

        },
        nodeVector(name) {
            let img = `/assets/file_types/${ftype.getVectorOf(ftype.getExt(name))}.svg`;
            return img;
        },
        showFiles(r) {
            this.selected_response = r;
            this.openShowFilesModal()

        },
        totalSizeFromQueryResponse(r) {
            let total = 0;
            try {
                r.file_hashes_sizes.filter((o) => {
                    total += o
                })
            } catch (e) {
                total = 0;
            }

            return total
        },
        getFees(hexVal) {
            try {
                let valBig = new BigNumber(hexVal, 16);
                let valInFFG = Units.convert(valBig.toString(10), "FFGOne", "FFG")
                return new BigNumber(valInFFG, 10).toString(10)
            } catch (e) {
                return ""
            }
        },
        async searchNetwork() {
            try {
                this.downloadError = "";
                if (this.file_hashes == "") {
                    this.searchError = "Please provide file hash(es)"
                    return;
                } else {
                    this.searchError = ""
                }

                this.searching = true;
                clearInterval(this.checkDataQueryResponseInterval);

                if(this.dataQueryRequestHash == "") {
                    const data = {
                        jsonrpc: '2.0',
                        method: "data_transfer.SendDataQueryRequest",
                        params: [{ file_hashes: this.file_hashes }],
                        id: 1
                    };
                    const response = await axios.post(localNodeEndpoint, data);
                    this.dataQueryRequestHash = response.data.result.hash;
                }

                let retries = 0;
                this.checkDataQueryResponseInterval = setInterval(async () => {
                    if (retries > 20) {
                        clearInterval(this.checkDataQueryResponseInterval);
                        this.searching = false;
                        return
                    }
                    retries++;
                    // rebroadcast the data query if nothing was found
                    if (retries % 4 == 0) {
                        const data = {
                            jsonrpc: '2.0',
                            method: "data_transfer.RebroadcastDataQueryRequest",
                            params: [{ hash: this.dataQueryRequestHash }],
                            id: 1
                        };

                        await axios.post(localNodeEndpoint, data);
                    }

                    if (retries % 3 == 0) {
                        const data = {
                            jsonrpc: '2.0',
                            method: "data_transfer.RequestDataQueryResponseFromVerifiers",
                            params: [{ data_query_request_hash: this.dataQueryRequestHash }],
                            id: 1
                        };

                        await axios.post(localNodeEndpoint, data);
                    }

                    const data = {
                        jsonrpc: '2.0',
                        method: "data_transfer.CheckDataQueryResponse",
                        params: [{ data_query_request_hash: this.dataQueryRequestHash }],
                        id: 1
                    };
                    const response = await axios.post(localNodeEndpoint, data);

                    response.data.result.responses.sort((a, b) => a.fees_per_byte != b.fees_per_byte && this.isFreeDownload(a) ? -1 : 1);
                    this.responses = response.data.result.responses;

                }, 1000)
            } catch (e) {
                this.searchError = e.response.data.error;
                this.searching = false;
            }
        },
        async getBalance() {
            const data = {
                jsonrpc: '2.0',
                method: "address.Balance",
                params: [{ address: this.nodeAddress }],
                id: 1
            };
            const endpoint = ref(globalState.rpcEndpoint);
            const response = await axios.post(endpoint.value, data);
            return response.data.result;
        },
        openFileSearchModal() {
            const myModal = document.getElementById('modal-searchfile');
            const modal = window.UIkit.modal(myModal);
            modal.show();
        },
        closeFileSearchModal() {
            const myModal = document.getElementById('modal-searchfile');
            const modal = window.UIkit.modal(myModal);
            modal.hide();
        },
        openShowFilesModal() {
            const myModal = document.getElementById('modal-showfiles');
            const modal = window.UIkit.modal(myModal);
            modal.show();
        },
        closeShowFilesModal() {
            const myModal = document.getElementById('modal-showfiles');
            const modal = window.UIkit.modal(myModal);
            modal.hide();
        },
        openDownloadConfirmationModal() {
            const myModal = document.getElementById('modal-confirmDownload');
            const modal = window.UIkit.modal(myModal);
            modal.show();
        },
        closeDownloadConfirmationModal() {
            const myModal = document.getElementById('modal-confirmDownload');
            const modal = window.UIkit.modal(myModal);
            modal.hide();
        },
    }
}
</script>

<style scoped>.circles {
    padding: 0px;
    margin: 0px;
    position: relative;
}

.wallet-button {
    --ripple-color: #fff;
    cursor: pointer;
    background-color: transparent;
    border: 2px solid #fff;
    border-radius: 3px;
    --keyboard-offset: 0px;
    --offset-top: 0px;
    --offset-bottom: 0px;
    --overflow: hidden;
    --color-activated: var(--color);
    --color-focused: var(--color);
    --color-hover: var(--color);
    display: inline-block;
    font-family: var(--ion-font-family, inherit);
    text-align: center;
    text-decoration: none;
    text-overflow: ellipsis;
    white-space: nowrap;
    user-select: none;
    vertical-align: -webkit-baseline-middle;
    font-kerning: none;
    --border-radius: 4px;
    --padding-top: 0;
    --padding-bottom: 0;
    --padding-start: 1.1em;
    --padding-end: 1.1em;
    --transition: box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1), background-color 15ms linear, color 15ms linear;
    margin-inline: 2px;
    margin-top: 4px;
    margin-bottom: 4px;
    height: 36px;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    --background: transparent;
    --color: var(--ion-color-primary, #3880ff);
    --border-width: 2px;
    --border-style: solid;
    --box-shadow: none;
    --background-activated: transparent;
    --background-focused: var(--ion-color-primary, #3880ff);
    --background-hover: var(--ion-color-primary, #3880ff);
    --background-activated-opacity: 0;
    --background-focused-opacity: 0.12;
    --background-hover-opacity: 0.04;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    width: 100px;
    --border-color: #ffffff;
    color: rgb(255, 255, 255);
}

.ffg-button-search {
    background-color: #f0f0f0;
    color: white;
    border-radius: 3px;
    text-transform: none;
}

.ffg-button-search:hover {
    background-color: #cecece;
    color: white;
    border-radius: 3px;
    text-transform: none;
}</style>
